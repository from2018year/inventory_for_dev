{%extends 'main_base.html'%}
{%load i18n%}
{%load url from future%}

{%block title%}{%trans '新增收款单'%}{%endblock%}


{%block content%}
<div class="container-fluid">
	<div class="f-main">
		<div class="main-wrap-no-right">
			<form id="invoice_form" class="form-horizontal form-min-horizontal" method="post" action="{%url 'shoukuandan_add' org.uid%}">{%csrf_token%}		
			<div class="widget-box">
				<div class="widget-title">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '编辑收款单据'%}</h5>
					<div class="widget-title-option">
						<a href="{%url 'shoukuandan_view' org.uid%}" class="btn btn-primary">{%trans '返回单据列表'%}</a>
						<input type="hidden" name="invoice" value="{{invoice.id}}">
					</div>
				</div>
				<div class="widget-content">
						<div class="row-fluid">
			            	<div class="span3">
			                    <div class="control-group {%if form.invoice_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.invoice_code.auto_id}}">{%if form.invoice_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.invoice_code.label}}</label>
			                         <div class="controls">
			                            {{form.invoice_code}}
			                            <p class="help-block">{{form.invoice_code.help_text}}</p>
										<p class="help-block">{{form.invoice_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.voucher_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.voucher_code.auto_id}}">{%if form.voucher_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.voucher_code.label}}</label>
			                         <div class="controls">
			                            {{form.voucher_code}}
			                            <p class="help-block">{{form.voucher_code.help_text}}</p>
										<p class="help-block">{{form.voucher_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.event_date.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.event_date.auto_id}}">{%if form.event_date.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.event_date.label}}</label>
			                         <div class="controls">
			                            {{form.event_date}}
			                            <p class="help-block">{{form.event_date.help_text}}</p>
										<p class="help-block">{{form.event_date.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.user.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.user.auto_id}}">{%if form.user.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.user.label}}</label>
			                         <div class="controls">
			                            {{form.user}}
			                            <p class="help-block">{{form.user.help_text}}</p>
										<p class="help-block">{{form.user.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			             </div>
			             <div class="row-fluid">
			                <div class="span3">
			                    <div class="control-group {%if form.warehouse_root.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.warehouse_root.auto_id}}">{%if form.warehouse_root.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.warehouse_root.label}}</label>
			                         <div class="controls">
			                            {{form.warehouse_root}}
			                            <p class="help-block">{{form.warehouse_root.help_text}}</p>
										<p class="help-block">{{form.warehouse_root.errors}}</p>
			                         </div> 
			                    </div>
			                </div>

			                <!--<div class="span3">
			                    <div class="control-group {%if form.invoice_from.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.invoice_from.auto_id}}">{%if form.invoice_from.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.invoice_from.label}}</label>
			                         <div class="controls">
			                            {{form.invoice_from}}
			                            <p class="help-block">{{form.invoice_from.help_text}}</p>
										<p class="help-block">{{form.invoice_from.errors}}</p>
			                         </div> 
			                    </div>
			                </div> -->

			                <div class="span3">
			                    <div class="control-group {%if form.total_pay.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.total_pay.auto_id}}">{%if form.total_pay.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.total_pay.label}}</label>
			                         <div class="controls">
			                            {{form.total_pay}}
			                            <p class="help-block">{{form.total_pay.help_text}}</p>
										<p class="help-block">{{form.total_pay.errors}}</p>
			                         </div> 
			                    </div>
			                </div>

			                <div class="span3">
			                    <div class="control-group {%if form.already_pay.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.already_pay.auto_id}}">{%if form.already_pay.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.already_pay.label}}</label>
			                         <div class="controls">
			                            {{form.already_pay}}
			                            <p class="help-block">{{form.already_pay.help_text}}</p>
										<p class="help-block">{{form.already_pay.errors}}</p>
			                         </div> 
			                    </div>
			                </div>

			                <div class="span3">
			                    <div class="control-group {%if form.rels.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.rels.auto_id}}">{%if form.rels.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.rels.label}}</label>
			                         <div class="controls">
			                            {{form.rels}}
			                            <p class="help-block">{{form.rels.help_text}}</p>
										<p class="help-block">{{form.rels.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                </div>


                            <div class="row-fluid">
			                <div class="span3">
			                    <div class="control-group {%if form.rest_pay.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.rest_pay.auto_id}}">{%if form.rest_pay.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.rest_pay.label}}</label>
			                         <div class="controls">
			                            {{form.rest_pay}}
			                            <p class="help-block">{{form.rest_pay.help_text}}</p>
										<p class="help-block">{{form.rest_pay.errors}}</p>
			                         </div> 
			                    </div>
			                </div>

			                <div class="span3">
			                    <div class="control-group {%if form.sstatus.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.sstatus.auto_id}}">{%if form.sstatus.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.sstatus.label}}</label>
			                         <div class="controls">
			                            {{form.sstatus}}
			                            <p class="help-block">{{form.sstatus.help_text}}</p>
										<p class="help-block">{{form.sstatus.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			             
			             <div class="span3">
			             	<div class="control-group {%if form.remark.errors%}error{%endif%}">
			             		<label class="control-label" for="{{form.remark.auto_id}}">{% trans '备注：' %}</label>
			             		<div class="controls">
			                            {{form.remark}}
			                         </div> 
			             	</div>
			             </div>
			             </div>
			             <hr></hr>
			             {% if invoice != -1%}
			             <div class="widget-title">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '付款明细'%}</h5>
				    </div>
                        <table class="table" style="margin: 0 20px">
                        <thead><tr><th>{% trans '序号' %}</th><th>{% trans '付款日期' %}</th><th>{% trans '结算账户' %}</th><th>{% trans '收款金额' %}</th><th>{% trans '结算方式' %}</th><th>{% trans '备注' %}</th>
			             	<th>操作</th></tr></thead>
			             <tbody>
			             {% for detail in details%}
			             <tr><td>{{forloop.counter}}</td><td>{{detail.event_date|date:'Y-m-d'}}</td><td>{{detail.account}}</td><td>{{detail.pay}}</td><td>{{detail.pay_type}}</td><td>{{detail.remark}}</td><td><a href="{%url 'delete_paydetail' org.uid detail.id%}" onclick= "if(confirm( "{%trans '是否删除该支付明细？' %}")==false)return   false; ">{% trans '删除' %}</a></td></tr>
			             {% endfor %}
			             </tbody>
                        </table>
			             <hr></hr>
			             {% endif %}
			             
			             <div class="widget-title">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '添加收款'%}</h5>
				    </div>
			            <table class="table" style="margin:0 20px">
			             	<thead><tr><th>{% trans '序号' %}</th><th>{% trans '收款日期' %}</th><th>{% trans '结算账户' %}</th><th>{% trans '收款金额（请输入数字）' %}</th><th>{% trans '结算方式' %}</th><th>{% trans '备注' %}</th>
			             	</tr></thead>
			             	<tbody id="tbody">
			             	<tr><td>1</td><td><input type="text" onClick=WdatePicker() id="date1"></td><td><select id="account1">
			             	{%for account in accounts%}
			             	<option value="{{account.id}}">{{account.account_name}}</option>
			             	{% endfor %}
			             	</select><abbr title="{%trans '点击新增账户'%}"><a href="{%url 'add_bank_account' org.uid%}" class="layer" width="800px" height="600px" title="{%trans '添加新账户'%}"><i id="new_org_cus" class="icon-plus" ></i></a></abbr></td><td><input type="text" id="pay1" placeholder="请输入数字" class="pay" /><div><span style="color: red;">{% trans '请填写收款金额' %}</span></div></td><td><input type="text" id="pay_type1" /></td><td><input type="text" id="remark1"/></td></tr>
			             	</tbody>
			             </table>
			        <input type="hidden" name="detail" id="detail" value="" /> 
			       	<div class="form-actions no-margin">
						<input type="submit" id="submit"  class="btn btn-primary disabled" value="{%trans '确定'%}" disabled="disabled" />
						<input type="button" id="addrow" class="btn btn-warning" value="{%trans '增加一栏'%}" count="2" style="margin-left: 20px;">
						<span style="color: red;margin-left: 30px" id="error_msg">
						{% if error_msg %}
						{{error_msg}}
						{% endif %}
						</span>
					</div>
			    </div>
			</div>
			
			
			</form>
			<input type="hidden" id="cellTotal" value="0" />
		</div>
			
	</div>

	
	<div class="f-left">
		<div class="left-wrap">
			{%include 'parts/main_left_nav.html'%}
		</div>
	</div>

	<!--div class="f-right">
		<div class="right-wrap">
			
		</div>
	</div-->
	
	
</div>
{%endblock%}
{%block endrel%}
<script language="JavaScript" src="/static/js/common/DatePicker/WdatePicker.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function(){
	$("#addrow").click(function(){
		var count = $(this).attr("count")
        $("#tbody").append("<tr><td>"+count+"</td><td><input type='text' id='date"+count+"' onClick=WdatePicker() /></td><td><select id='account"+count+"' >{%for account in accounts%}<option value='{{account.id}}'>{{account.account_name}}</option>{% endfor %}</select></td><td><input type='text' id='pay"+count+"' placeholder='请输入数字' class='pay' value=0 /><div><span></span></div></td><td><input type='text' id='pay_type"+count+"' /></td><td><input type='text' id='remark"+count+"' /></td></tr>")
        $(this).attr("count",parseInt(count) + 1)
	})


	//提交表单详情
	$("#submit").on('click',function(){
        var data = []
		var count = $("#addrow").attr("count")
		for(var i=1;i<count;i++){
			var detail = {event_date:$("#date"+i).val(),account:$("#account"+i).val(),pay:$("#pay"+i).val(),pay_type:$("#pay_type"+i).val(),remark:$("#remark"+i).val()}

			data.push(detail)
		}

		$("#detail").val(JSON.stringify({'detail':data}))

	})

	//验证填写数字信息
    $("#tbody").on("change",".pay",function(){
		var pay = $(this).val();
		var reg = new RegExp(/^[0-9]+([.]{1}[0-9]{1,2})?$/);
		var total_pay = Number($("#id_total_pay").val())
		if(!reg.test(pay) || Number(pay)>total_pay || pay==''){
             $("#submit").addClass("disabled")
             $("#submit").attr("disabled","disabled")
             $(this).css("border","1px solid red")
             if(pay==''){
                $(this).siblings("div").children("span").text("{% trans '金额不能为空' %}")
             }else if(Number(pay)>total_pay){
             	$(this).siblings("div").children("span").text("{% trans '金额大于应收金额' %}")
             }else{
             	$(this).siblings("div").children("span").text("{% trans '请输入数字' %}")
             }
             
             $(this).siblings("div").children("span").css("color","red")
		}else{
			$("#submit").removeClass("disabled")
			$("#submit").removeAttr("disabled")
			$(this).css("border","1px solid #ccc")
			$(this).siblings("div").children("span").text("")
		}

	})

	$("#id_total_pay").on("change",function(){
		var total_pay = Number($(this).val())
		var pays = $("#tbody").find(".pay");
		var reg = new RegExp(/^[0-9]+([.]{1}[0-9]{1,2})?$/);
		for(var i=0;i<pays.length;i++){

			var pay = $(pays[i]).val()
			if(!reg.test(pay) || Number(pay)>total_pay || pay==''){
             $("#submit").addClass("disabled")
             $("#submit").attr("disabled","disabled")
             $(pays[i]).css("border","1px solid red")
             if(pay==''){
                $(pays[i]).siblings("div").children("span").text("{% trans '金额不能为空' %}")
             }else if(Number(pay)>total_pay){
             	$(pays[i]).siblings("div").children("span").text("{% trans '金额大于应收金额' %}")
             }else{
             	$(pays[i]).siblings("div").children("span").text("{% trans '请输入数字' %}")
             }
             
             $(pays[i]).siblings("div").children("span").css("color","red")
		}else{
			$("#submit").removeClass("disabled")
			$("#submit").removeAttr("disabled")
			$(pays[i]).css("border","1px solid #ccc")
			$(pays[i]).siblings("div").children("span").text("")
		}
		}

	})
})
</script>
{% endblock %}