{%extends 'main_base.html'%}
{%load i18n%}
{%load url from future%}
{%block title%}{%trans '新增库位调拨'%}{%endblock%}

{%block content%}
<div class="container-fluid">
	<div class="f-main">
		<div class="main-wrap-no-right">
			<form id="invoice_form" class="form-horizontal form-min-horizontal" onkeypress="if(event.keyCode==13||event.which==13){return false;}" method="post" action="">{%csrf_token%}		
			<div class="widget-box">
				<div class="widget-title">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '编辑库位调拨单据'%}</h5>
					<div class="widget-title-option">
						<a href="{%url 'kuweidiaobo' org.uid%}" class="btn btn-primary">{%trans '返回单据列表'%}</a>
					</div>
				</div>
				<div class="widget-content">
						<div class="row-fluid">
			            	<div class="span3">
			                    <div class="control-group {%if form.invoice_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.invoice_code.auto_id}}">{%if form.invoice_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.invoice_code.label}}</label>
			                         <div class="controls">
			                            {{form.invoice_code}}
			                            <p class="help-block">{{form.invoice_code.help_text}}</p>
										<p class="help-block">{{form.invoice_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.voucher_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.voucher_code.auto_id}}">{%if form.voucher_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.voucher_code.label}}</label>
			                         <div class="controls">
			                            {{form.voucher_code}}
			                            <p class="help-block">{{form.voucher_code.help_text}}</p>
										<p class="help-block">{{form.voucher_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.event_date.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.event_date.auto_id}}">{%if form.event_date.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.event_date.label}}</label>
			                         <div class="controls">
			                            {{form.event_date}}
			                            <p class="help-block">{{form.event_date.help_text}}</p>
										<p class="help-block">{{form.event_date.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.user.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.user.auto_id}}">{%if form.user.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.user.label}}</label>
			                         <div class="controls">
			                            {{form.user}}
			                            <p class="help-block">{{form.user.help_text}}</p>
										<p class="help-block">{{form.user.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			             </div>
			             <div class="row-fluid">
			                <div class="span3">
			                    <div class="control-group {%if form.warehouse_root.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.warehouse_root.auto_id}}">{%if form.warehouse_root.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.warehouse_root.label}}</label>
			                         <div class="controls">
			                            {{form.warehouse_root}}
			                            <p class="help-block">{{form.warehouse_root.help_text}}</p>
										<p class="help-block">{{form.warehouse_root.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			         
			               	<div class="span3">
			                    <div class="control-group {%if form.rels.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.rels.auto_id}}">{%if form.rels.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.rels.label}}</label>
			                         <div class="controls">
			                            {{form.rels}}
			                            <p class="help-block">{{form.rels.help_text}}</p>
										<p class="help-block">{{form.rels.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.sstatus.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.sstatus.auto_id}}">{%if form.sstatus.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.sstatus.label}}</label>
			                         <div class="controls">
			                            {{form.sstatus}}
			                            <p class="help-block">{{form.sstatus.help_text}}</p>
										<p class="help-block">{{form.sstatus.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			             </div>
			             
			             <hr></hr>
			             
			             <table class="table no-margin">
			             	<thead><tr><th width="50px"></th><th>{%trans '物品'%}</th><th width="90px">{%trans '调出位置'%}</th><th width="90px">{%trans '调入位置'%}</th><th width="85px">{%trans '数量&单位'%}</th><th width="85px">{%trans '单价'%}</th><th width="85px">{%trans '总价'%}</th></tr></thead>
			             </table>
			             <div id="invocie-body" style="width:100%;overflow: visible"></div>
			             
			        	
			         
			       	<div class="form-actions no-margin">
						<input type="button" id="submit" class="btn btn-primary" value="{%trans '确定'%}"/>
						
					</div>
			    </div>
			</div>
			
			
			</form>
			<input type="hidden" id="cellTotal" value="0" />
		</div>
			
	</div>

	
	<div class="f-left">
		<div class="left-wrap">
			{%include 'parts/main_left_nav.html'%}
		</div>
	</div>

	<!--div class="f-right">
		<div class="right-wrap">
			
		</div>
	</div-->
	
	<div id="goods_layer" class="xubox_layer hide" style="z-index:500;width:800px;height:500px;left:50%;top:50%;margin-left:-400px;margin-top:-250px; ">

	    <div class="xubox_main" style="background-color: #FFF;z-index: 500;width:800px;height: 500px;">
	        <div class="xubox_page">
	        	<iframe id="select_goods_frame" src="" width="800px" height="500px" scrolling="no" frameborder="0"></iframe>
	        </div>
	        <a class="xubox_close xulayer_png32 xubox_close0 xubox_close1 goods_layer_close" href="javascript:;"></a>
	        <span class="xubox_botton"></span>
	    </div>
    	<div class="" style="position: absolute;border-radius: 5px;z-index: 49; background-color: #000; opacity: 0.3;filter:alpha(opacity=30);-moz-opacity:0.5; top: -2px; left: -2px; width: 804px; height: 504px;"></div>
		<div style="background-color: #666;width: 100%;height: 100%;left: 0px;top: 0px;opacity: 0.5;filter:alpha(opacity=50);-moz-opacity:0.5;z-index: 1;position: fixed !important;"></div>
	</div>
	
</div>
{%endblock%}

{%block rel%}
<link href="/static/js/handsontable/jquery.handsontable.full.css" rel="stylesheet">
{%endblock%}

{%block endrel%}
<script language="JavaScript" src="/static/js/common/DatePicker/WdatePicker.js" type="text/javascript"></script>
<script src="/static/js/handsontable/jquery.handsontable.full.js"></script>
<script src="/static/js/handsontable/customerh.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	$('#li_kuweidiaobo').addClass('current');	
	$('#tab-warehouse').addClass('active');

	$goods_layer=$('#goods_layer');
	NEW_SRC="{%url 'add_goods' org.pk%}?callback=1";

	var datas={{datas|safe}};
	var columns=[
	 			{data:0,renderer: hiddenRenderer},
				{data:1,renderer:'autocompletefind',editor:'autocompletefind',type:'autocomplete',layer_id:'goods_layer',
					source: function(query,process){
						//var items=$.grep(goods_json,function(n,i){return (n.code.indexOf(query)>-1)||(n.abbreviation.indexOf(query)>-1)||(n.name.indexOf(query)>-1)})
						var query=query.toUpperCase().trim();
						process($.map(goods_json,function(n){return ((n.code.indexOf(query)>-1)||(n.abbreviation.indexOf(query)>-1)||(n.name.indexOf(query)>-1))?n.name:null}));
					}
				},
				{data:2,editor:'select',selectOptions: []},
				{data:3,editor:'select',selectOptions: []},
				{data:4,type:'numeric',renderer:hiddenRightBorderRender,validator: /^[\d\.]*$/},
				{data:5,editor:'unitselect',selectOptions:[]},
				{data:6,type:'numeric',format: '0.00',validator: /^[\d\.]*$/},
				{data:7,type:'numeric',renderer:totalPriceRender,format: '$0.00',language: 'zh-cn'},
				{data:8,renderer: hiddenRenderer}
			];
	$("#invocie-body").handsontable({
		data:datas,
		minRows: 6,
		minSpareRows: 1,
		//colHeaders: [null,"单位","单位备注"],
		rowHeaders: true,
		columns:columns,
		colWidths :[$('.widget-content').width()-550,100,100,50,50,100,100,1,1],
		contextMenu:{
			items:{
				'row_above':{name:"{%trans '上行插入行'%}"},
				'row_below':{name:"{%trans '下行插入行'%}"},
				'remove_row':{name:"{%trans '删除行'%}"},
			}
		}
	});

	$container = $("#invocie-body").handsontable('getInstance');
	


	$('#{{form.warehouse_root.auto_id}}').change(function(){
		var w_text=$(this).find('option:selected').text();
		//首先调整所填物品的货位
		var warray={{warehouse_list_str|slice:""|safe}};
		columns[2]['selectOptions']=$.map(warray,function(n){return (n.indexOf(w_text)==0)?n:null});
		$container.updateSettings({columns:columns});


		$('#select_goods_frame').attr('src',"{%url 'select_goods_use' org.pk%}?warehouse_id="+$('#{{form.warehouse_root.auto_id}}').val());
		load_id=layer.load("{%trans '加载离线物品数据，请稍候...'%}");
		$.getScript("{%url 'get_diaobo_goods_json' org.pk%}?warehouse_id="+$('#{{form.warehouse_root.auto_id}}').val(),function(){
			if(typeof(goods_json)!="undefined"){
				for(var i=0;i<$container.countRows();i++){
					var v=$container.getDataAtCell(i,2);
					var pk=$container.getDataAtCell(i,0);
					var items=$.grep(goods_json,function(n,i){return n.pk===pk});
					var item=null;
					if(items.length){
						var item=items[0];

						var warehouses=[];
						for(var k=0;k<item.warehouses.length;k++){
							if(item.warehouses[k].indexOf(w_text)==0)
								warehouses.push(item.warehouses[k]);
						}
						$container.setCellMeta(i,2,'selectOptions',warehouses);
						$container.setDataAtCell(i,2,warehouses.length?warehouses[0]:'');
					}else{
						$container.alter('remove_row',i);
					}
				}
			}
			layer.close(load_id);
		});
	}).change();

	$('#{{form.rels.auto_id}}').change(function(){
		var w_text=$(this).find('option:selected').text();
		//首先调整所填物品的货位
		var warray={{warehouse_list_str|slice:""|safe}};
		columns[3]['selectOptions']=$.map(warray,function(n){return (n.indexOf(w_text)==0)?n:null});
		$container.updateSettings({columns:columns});

		for(var i=0;i<$container.countRows();i++){
			var v=$container.getDataAtCell(i,3);
			if(v && v.indexOf(w_text)!=0){
				$container.setDataAtCell(i,3,w_text);
			}
		}
	}).change();
});
function getParameterByName(name) {  
    var match = RegExp('[?&]' + name + '=([^&]*)')  
                    .exec(window.location.search);  
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));  
} 
$(window).load(function(){
	
	//加载离线物品数据，goods_json
	
	var resizeTimer;
	window.onresize = function(){
	    if (resizeTimer){
	        clearTimeout(resizeTimer);
	    } 
	    resizeTimer = setTimeout(function(){
	    	$container.updateSettings({'colWidths':[$('.widget-content').width()-550,100,100,50,50,100,100,1,1]});
	        }, 100);
	};
});


function updateRow(cur_row,change_value){
	if(!change_value){
		change_value=$container.getDataAtCell(cur_row,1);
	}

	var items=$.grep(goods_json,function(n,i){return n.name===change_value||n.code===change_value});
	if(!items.length){
		return;
	}
	
	var item=items[0];
	$container.setDataAtCell(cur_row,0,item.pk);
	$container.setDataAtCell(cur_row,1,item.name);
	$container.setDataAtCell(cur_row,4,1);
	$container.setDataAtCell(cur_row,6,item.price||0);

	var warehouses=[];
	var w_text=$('#{{form.warehouse_root.auto_id}} option:selected').text();
	for(var k=0;k<item.warehouses.length;k++){
		
		if(item.warehouses[k].indexOf(w_text)==0)
			warehouses.push(item.warehouses[k]);
	}
	$container.setCellMeta(cur_row,2,'selectOptions',warehouses);
	$container.setDataAtCell(cur_row,2,warehouses.length?warehouses[0]:'');

	if(item.unit){
		var units=[item.unit];
		$container.setDataAtCell(cur_row,5,item.unit);
		if(item.auxiliary_unit){
			for(var k=0;k<item.auxiliary_unit.length;k++){
				units.push(item.auxiliary_unit[k].unit);
			}
		}
		$container.setCellMeta(cur_row,5,'selectOptions',units);

	}else{
		$container.setDataAtCell(cur_row,5,'');
		$container.setCellMeta(cur_row,5,'selectOptions',[]);
	}
}
</script>
{%endblock%}