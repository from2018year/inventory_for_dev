{%extends 'main_base.html'%}
{%load i18n%}
{%load url from future%}

{%block title%}{%trans '新增采购入库单'%}{%endblock%}
{%block content%}
<div class="container-fluid">
	<div class="f-main">
		<div class="main-wrap-no-right">
			<form id="invoice_form" class="form-horizontal form-min-horizontal" onkeypress="if(event.keyCode==13||event.which==13){return false;}" method="post" action="">{%csrf_token%}		
			<div class="widget-box">
				<div class="widget-title">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '编辑采购入库单据'%}</h5>
					<div class="widget-title-option">
						<a href="{%url 'caigouruku' org.uid%}" class="btn btn-primary">{%trans '返回单据列表'%}</a>
					</div>
				</div>
				<div class="widget-content">
						<div class="row-fluid">
			            	<div class="span3">
			                    <div class="control-group {%if form.invoice_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.invoice_code.auto_id}}">{%if form.invoice_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.invoice_code.label}}</label>
			                         <div class="controls">
			                            {{form.invoice_code}}
			                            <p class="help-block">{{form.invoice_code.help_text}}</p>
										<p class="help-block">{{form.invoice_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.voucher_code.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.voucher_code.auto_id}}">{%if form.voucher_code.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.voucher_code.label}}</label>
			                         <div class="controls">
			                            {{form.voucher_code}}
			                            <p class="help-block">{{form.voucher_code.help_text}}</p>
										<p class="help-block">{{form.voucher_code.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.event_date.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.event_date.auto_id}}">{%if form.event_date.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.event_date.label}}</label>
			                         <div class="controls">
			                            {{form.event_date}}
			                            <p class="help-block">{{form.event_date.help_text}}</p>
										<p class="help-block">{{form.event_date.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.user.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.user.auto_id}}">{%if form.user.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.user.label}}</label>
			                         <div class="controls">
			                            {{form.user}}
			                            <p class="help-block">{{form.user.help_text}}</p>
										<p class="help-block">{{form.user.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			             </div>
			             <div class="row-fluid">
			             	<div class="span3">
			                    <div class="control-group {%if form.rels.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.rels.auto_id}}">{%if form.rels.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.rels.label}}</label>
			                         <div class="controls" style="position: relative;">
			                            {{form.rels}}&nbsp;<abbr title="{%trans '点击新增供货商'%}"><i id="new_org_supplier" class="icon-plus" style="position:absolute;top:7px;right:-20px;"></i></abbr>
			                            <p class="help-block">{{form.rels.help_text}}</p>
										<p class="help-block">{{form.rels.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			                    <div class="control-group {%if form.warehouse_root.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.warehouse_root.auto_id}}">{%if form.warehouse_root.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.warehouse_root.label}}</label>
			                         <div class="controls">
			                            {{form.warehouse_root}}
			                            <p class="help-block">{{form.warehouse_root.help_text}}</p>
										<p class="help-block">{{form.warehouse_root.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <!-- <div class="span3">
			                    <div class="control-group {%if form.result.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.result.auto_id}}">{%if form.result.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.result.label}}</label>
			                         <div class="controls">
			                            {{form.result}}
			                            <p class="help-block">{{form.result.help_text}}</p>
										<p class="help-block">{{form.result.errors}}</p>
			                         </div> 
			                    </div>
			                </div> -->
			               <div class="span3" style="display: none;">
			                    <div class="control-group {%if form.sstatus.errors%}error{%endif%}">
			                        <label class="control-label" for="{{form.sstatus.auto_id}}">{%if form.sstatus.field.required%}<i class="icon icon-asterisk"></i>{%endif%}{{form.sstatus.label}}</label>
			                         <div class="controls">
			                            {{form.sstatus}}
			                            <p class="help-block">{{form.sstatus.help_text}}</p>
										<p class="help-block">{{form.sstatus.errors}}</p>
			                         </div> 
			                    </div>
			                </div>
			                <div class="span3">
			             	<div class="control-group {%if form.sstatus.errors%}error{%endif%}">
			             		<label class="control-label" for="{{form.remark.auto_id}}">{% trans '备注：' %}</label>
			             		<div class="controls">
			                            {{form.remark}}
			                         </div> 
			             	</div>
			             </div>
			             </div>

			            
			             
			             <hr></hr>
			             <table class="table no-margin">
			             	<thead><tr><th width="40px"></th><th width="50px">{% trans '操作' %}</th><th id="good_name">{%trans '物品'%}</th><th width="85px" style="text-align: right">{%trans '位置'%}</th><!--<th width="85px" style="text-align: right;">{%trans '保质期'%}</th>--><th width="85px" style="text-align: right">{%trans '数量&单位'%}</th><th width="85px" style="text-align: right">{%trans '单价'%}</th><th width="85px" style="text-align: right">{%trans '总价'%}</th><th width="85px" style="text-align: right">{%trans '物品编号'%}</th><!--<th width="85px" style="text-align: right">{%trans '规格'%}</th>--><th width="85px" style="text-align: right">{%trans '分类'%}</th><th width="85px" style="text-align: right">{%trans '当前库存'%}</th><th width="85px" style="text-align: right">{%trans '库存下限'%}</th><th width="85px" style="text-align: right">{%trans '备注'%}</th></tr></thead>
			             </table>
			             <div id="invocie-body" style="width:100%;overflow: visible"></div>

			             <div class="row-fluid">
			        <div class="widget-title" style="margin-top: 30px;">
					<span class="icon"><i class="icon-th-list"></i></span>
					<h5>{%trans '添加付款'%}</h5>
				    </div>
			            <table class="table" style="margin:0 20px">
			             	<thead><tr><th style="width: 30px;">{% trans '序号' %}</th><th>{% trans '付款日期' %}</th><th>{% trans '结算账户' %}</th><th>{% trans '付款金额（请输入数字）' %}</th><th>{% trans '结算方式' %}</th><th>{% trans '备注' %}</th>
			             	</tr></thead>
			             	<tbody id="tbody">
			             	<input type="hidden" name="pay_id" value="{{pay_details.0.invoice.id}}">
			             	{% for detail in pay_details %}
			             	<tr><td>000{{forloop.counter}}</td><td><input type="text" onClick=WdatePicker() name="date" value="{{detail.event_date|date:'Y-m-d'}}"></td><td><select name="account" id="account" value="{{detail.account.id}}">
			             	{% for account in accounts%}
			             	<option value="{{account.id}}" {% if detail.account.id == account.id %}selected="selected"{% endif %}>{{account.account_name}}</option>
			             	{% endfor %}
			             	</select></td><td><input type="text" name="pay" value="{{detail.pay}}" class="pay" /><div><span></span></div></td><td><input type="text" name="pay_type" value="{{detail.pay_type}}" /></td><td><input type="text" name="detail_remark" value="{{detail.remark}}" /></td></tr>
			             	{% endfor %}
			             	</tbody>
			             </table>
			             </div>
			         
			       	<div class="form-actions no-margin" style="padding-top: 20px;">
						<input type="button" id="submit"  class="btn btn-primary" value="{%trans '确定'%}"
						 {% if invoice.status == 2 %} style="display: none;" {% endif %} />
						<span style="color: red;margin-left: 30px;{% if invoice.status == 2 %}display: none;{% endif %}" id="error_msg">{{error_msg}}</span>
						{% if invoice.status == 2%}
						<img src="/static/images/icons/is_confirm.png" />
						{% endif %}
					</div>
			    </div>
			</div>
			
			
			</form>
			<input type="hidden" id="cellTotal" value="0" />
		</div>
			
	</div>

	
	<div class="f-left">
		<div class="left-wrap">
			{%include 'parts/main_left_nav.html'%}
		</div>
	</div>

	<!--div class="f-right">
		<div class="right-wrap">
			
		</div>
	</div-->
	
	<div id="goods_layer" class="xubox_layer hide" style="z-index:500;width:800px;height:500px;left:50%;top:50%;margin-left:-400px;margin-top:-250px; ">

	    <div class="xubox_main" style="background-color: #FFF;z-index: 500;width:800px;height: 500px;">
	        <div class="xubox_page">
	        	<iframe id="select_goods_frame" src="" width="800px" height="500px" scrolling="no" frameborder="0"></iframe>
	        </div>
	        <a class="xubox_close xulayer_png32 xubox_close0 xubox_close1 goods_layer_close" href="javascript:;"></a>
	        <span class="xubox_botton"></span>
	    </div>
    	<div class="" style="position: absolute;border-radius: 5px;z-index: 49; background-color: #000; opacity: 0.3;filter:alpha(opacity=30);-moz-opacity:0.5; top: -2px; left: -2px; width: 804px; height: 504px;"></div>
		<div style="background-color: #666;width: 100%;height: 100%;left: 0px;top: 0px;opacity: 0.5;filter:alpha(opacity=50);-moz-opacity:0.5;z-index: 1;position: fixed !important;"></div>
	</div>
	
</div>
<style type="text/css">
.span3{
	transform:translateY(30%)
}
.container-fluid{
    overflow-X:hidden
}
</style>
{%endblock%}

{%block rel%}
<link href="/static/js/handsontable/jquery.handsontable.full.css" rel="stylesheet">
{%endblock%}

{%block endrel%}
<script language="JavaScript" src="/static/js/common/DatePicker/WdatePicker.js" type="text/javascript"></script>
<script src="/static/js/layer/layer.min.js"></script>
<script src="/static/js/handsontable/jquery.handsontable.full.js?v=20181109"></script>
<script src="/static/js/handsontable/customerh.js?v=20181109"></script>
<script type="text/javascript">
$(document).ready(function(){
	$('#li_caigouruku').addClass('current');	
	$('#tab-warehouse').addClass('active');

	$("#submit").click(function(){
		alert("{% trans '单据已提交，请等待处理勿重复提交,若单据有红色部分请先修复后再次提交' %}")
	})

	$("#account").children("option[value="+ parseInt($("#account").attr("value")) +"]").attr("selected","selected")
	$goods_layer=$('#goods_layer');
	NEW_SRC="{%url 'add_goods' org.pk%}?callback=1";

	var datas={{datas|safe}};
	$("#good_name").css("width",parseInt($(".widget-content").css("width"))-1050)

	//超过6个就做处理，否则显示不出来
	var extraData = []
	while(datas.length>5){
		var item = datas.pop()
		extraData.push(item)
	}

	extraData.reverse()


	var columns=[
	 			{data:0,renderer: hiddenRenderer},
	 			{data:1,renderer: safeHtmlRenderer,readOnly:"true"},
				{data:2,renderer:'autocompletefind',editor:'autocompletefind',type:'autocomplete',layer_id:'goods_layer',
					source: function(query,process){
						//var items=$.grep(goods_json,function(n,i){return (n.code.indexOf(query)>-1)||(n.abbreviation.indexOf(query)>-1)||(n.name.indexOf(query)>-1)})
						var query=query.toUpperCase().trim();
						process($.map(goods_json,function(n){return ((n.code.indexOf(query)>-1)||(n.abbreviation.indexOf(query)>-1)||(n.name.indexOf(query)>-1))?n.name:null}));
					}
				},
				//{data:3,editor:'select',selectOptions: []},
				//{data:4,type:'numeric',renderer:hiddenRightBorderRender,validator: /^[\d]*$/},
				{data:3,editor:'select',selectOptions:{{time_span|safe}}},
				{data:4,type:'numeric',validator: /^[\d\.]*$/,format:'0.00'},
				{data:5,editor:'unitselect',selectOptions:[]},
				{data:6,type:'numeric',format: '0.00',validator: /^[\d\.]*$/},
				{data:7,type:'numeric',renderer:totalPriceRender,format: '$0.00',language: 'zh-cn'},
				{data:8,renderer: hiddenRenderer},
				{data:9,readOnly:true},
				
				{data:10,readOnly:true},
				{data:11,readOnly:true,format:'0.00'},
				{data:12,readOnly:true},
				{data:13}
			];
	$("#invocie-body").handsontable({
		data:datas,
		minRows: 6,
		minSpareRows: 1,
		//colHeaders: [null,"单位","单位备注"],
		rowHeaders: true,
		colWidths :[50,$('.widget-content').width()-1000,100,50,50,100,100,100,100,100,100,100,100,1,1],
		contextMenu:{
			items:{
				'row_above':{name:"{%trans '上行插入行'%}"},
				'row_below':{name:"{%trans '下行插入行'%}"},
				'remove_row':{name:"{%trans '删除行'%}"},
			}
		},
		afterChange: function(changes,source){
		var total_pay = Number($(".htNumeric:last").text().substring(1).replace(',','.'))
		var pay = Number($(".pay").val())
		if(pay > total_pay){
		    $("#submit").addClass("disabled")
		    $("#submit").attr("disabled","disabled")
		    $("#error_msg").text("{% trans '已付金额大于应付金额' %}")
		}else{
		    $("#submit").removeClass("disabled")
		    $("#submit").removeAttr("disabled")
		    $("#error_msg").text("")
		}

		},
		afterInit:function(){
			var rows = this.countRows()
			for(var i=0;i<rows-1;i++){
				this.setDataAtCell(i,1,"<img class='add' src='/static/images/icons/add2.png' style='width:10px;height:10px;margin-left:5px;cursor:pointer;' /><img src='/static/images/icons/delete2.png'  class='minus' style='width:9px;height:9px;margin-left:10px;margin-top:1px;cursor:pointer;' />")
            }

            for(var i=0;i<extraData.length;i++){
            	this.alter("insert_row")
            	this.setDataAtCell(this.countRows()-2,0,extraData[i][0])
            	this.setDataAtCell(this.countRows()-2,2,extraData[i][2])
            	this.setDataAtCell(this.countRows()-2,3,extraData[i][3])
            	this.setDataAtCell(this.countRows()-2,4,extraData[i][4])
            	this.setDataAtCell(this.countRows()-2,5,extraData[i][5])
            	this.setDataAtCell(this.countRows()-2,6,extraData[i][6])
            	this.setDataAtCell(this.countRows()-2,7,extraData[i][7])
            	this.setDataAtCell(this.countRows()-2,8,extraData[i][8])
            	this.setDataAtCell(this.countRows()-2,10,extraData[i][10])
            	this.setDataAtCell(this.countRows()-2,11,extraData[i][11])
            	this.setDataAtCell(this.countRows()-2,12,extraData[i][12])
            	this.setDataAtCell(this.countRows()-2,13,extraData[i][13])
            	this.setDataAtCell(this.countRows()-2,14,extraData[i][14])
            	this.setDataAtCell(this.countRows()-2,15,extraData[i][15])
            	this.setDataAtCell(this.countRows()-2,16,extraData[i][16])
            }



		},
		afterRender:function(){
			var that = this
			$(".add").on("click",function(){
				var rows = that.countRows()
        	    that.alter('insert_row',that.getSelected()[0]+1)
        	    that.setDataAtCell(that.getSelected()[0]+1,1,"<img class='add' src='/static/images/icons/add2.png' style='width:10px;height:10px;margin-left:5px;cursor:pointer;' /><img src='/static/images/icons/delete2.png'  class='minus' style='width:9px;height:9px;margin-left:10px;margin-top:1px;cursor:pointer;' />")
			})
			$(".minus").on("click",function(){  	
        	    that.alter('remove_row',that.getSelected()[0])
        	    var rows = that.countRows()
        	    if(rows == 6){
        	    	that.setDataAtCell(4,1,"<img class='add' src='/static/images/icons/add2.png' style='width:10px;height:10px;margin-left:5px;cursor:pointer;' /><img src='/static/images/icons/delete2.png'  class='minus' style='width:9px;height:9px;margin-left:10px;margin-top:1px;cursor:pointer;' />")
        	    }
			})

			var all_pay = 0
			for(var i=0;i<$(".pay").length;i++){
       			all_pay += Number($(".pay").val())
			}
			var total_pay = Number($(".htNumeric:last").text().substring(1).replace(',','.'))

			if(all_pay <= total_pay){
				console.log(123)
				$("#error_msg").text("")
			}
		},
		afterCreateRow:function(){
			var rows = this.countRows()
			if(rows > 6){
				this.setDataAtCell(rows-2,1,"<img class='add' src='/static/images/icons/add2.png' style='width:10px;height:10px;margin-left:5px;cursor:pointer;' /><img src='/static/images/icons/delete2.png'  class='minus' style='width:9px;height:9px;margin-left:10px;margin-top:1px;cursor:pointer;' />")
			}
		}
	});

	$container = $("#invocie-body").handsontable('getInstance');

	$('#{{form.warehouse_root.auto_id}}').change(function(){
		var w_text=$(this).find('option:selected').text();
		//首先调整所填物品的货位
		var warray={{warehouse_list_str|slice:""|safe}};
		columns[3]['selectOptions']=$.map(warray,function(n){return (n.indexOf(w_text)==0)?n:null});
		$container.updateSettings({columns:columns});

		for(var i=0;i<$container.countRows();i++){
			var v=$container.getDataAtCell(i,3);
			if(v && v.indexOf(w_text)!=0){
				$container.setDataAtCell(i,3,w_text);
			}
		}

		$('#select_goods_frame').attr('src',"{%url 'select_goods' org.pk%}?warehouse_id="+$('#{{form.warehouse_root.auto_id}}').val());
	}).change();



	//验证填写数字信息
    $("#tbody").on("change",".pay",function(){
		var pay = $(this).val();
		var reg = new RegExp(/^[0-9]+([.]{1}[0-9]{1,2})?$/);
		var total_pay = Number($(".htNumeric:last").text().substring(1).replace(',','.'))
		if(!reg.test(pay) || parseFloat(pay)>total_pay){
             $("#submit").addClass("disabled")
             $("#submit").attr("disabled","disabled")
             $(this).css("border","1px solid red")
             if(pay==''){
                $(this).siblings("div").children("span").text("{% trans '金额不能为空' %}")
             }else if(Number(pay)>total_pay){
             	$(this).siblings("div").children("span").text("{% trans '金额大于应付金额' %}")
             }else{
             	$(this).siblings("div").children("span").text("{% trans '请输入数字' %}")
             }
             
             $(this).siblings("div").children("span").css("color","red")
		}else{
			$("#submit").removeClass("disabled")
			$("#submit").removeAttr("disabled")
			$(this).css("border","1px solid #ccc")
			$(this).siblings("div").children("span").text("")
			$("#error_msg").text("")
		}

	})


});
$(window).load(function(){
	$('#new_org_supplier').click(function(){
		$.layer({
			type:2,
			title:"{%trans '添加新供货商'%}",
			iframe:{src:"{%url 'add_supplier' org.uid%}?parent_id={{form.rels.auto_id}}"},
			area:["900px","550px"],
			offset : ['50px','']
		});
	});
	//加载离线物品数据，goods_json
	load_id=layer.load("{%trans '加载离线物品数据，请稍候...'%}");
	$.getScript("{%url 'get_goods_json' org.pk%}",function(){
		layer.close(load_id);
	});
	var resizeTimer;
	window.onresize = function(){
		$("#good_name").css("width",parseInt($(".widget-content").css("width"))-1050)
	    if (resizeTimer){
	        clearTimeout(resizeTimer);
	    } 
	    resizeTimer = setTimeout(function(){
	    	$container.updateSettings({'colWidths':[50,$('.widget-content').width()-1000,100,50,50,100,100,100,100,100,100,100,1,1]});
	        }, 100);
	};
});

function updateRow(cur_row,change_value){
	if(!change_value){
		change_value=$container.getDataAtCell(cur_row,1);
	}

	var items=$.grep(goods_json,function(n,i){return n.name===change_value||n.code===change_value});
	if(!items.length){
		return;
	}
	
	var item=items[0];
	$container.setDataAtCell(cur_row,0,item.pk);
	$container.setDataAtCell(cur_row,2,item.name);
	$container.setDataAtCell(cur_row,4,1);
	$container.setDataAtCell(cur_row,6,item.price_ori||0);
	$container.setDataAtCell(cur_row,9,item.code);
	$container.setDataAtCell(cur_row,10,item.category);
	$container.setDataAtCell(cur_row,11,item.nums);
	$container.setDataAtCell(cur_row,12,item.min_warning);
	$container.setDataAtCell(cur_row,13,item.remark);

	$container.setDataAtCell(cur_row,3,$('#{{form.warehouse_root.auto_id}} option:selected').text());
	//$container.setDataAtCell(cur_row,5,"{%trans '月'%}");
	//$container.selectCell(cur_row,2);
	
	
	if(item.unit){
		var units=[item.unit];
		$container.setDataAtCell(cur_row,5,item.unit);
		if(item.auxiliary_unit){
			for(var k=0;k<item.auxiliary_unit.length;k++){
				units.push(item.auxiliary_unit[k].unit);
			}
		}
		$container.setCellMeta(cur_row,5,'selectOptions',units);

	}else{
		$container.setDataAtCell(cur_row,5,'');
		$container.setCellMeta(cur_row,5,'selectOptions',[]);
	}
}

</script>
{%endblock%}